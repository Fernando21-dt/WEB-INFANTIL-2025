import{auth as t,db as e}from'./firebase-config.js';import{createUserWithEmailAndPassword as n,signInWithEmailAndPassword as a,onAuthStateChanged as o,signOut as r,updateProfile as i}from"https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";import{doc as d,setDoc as s,getDoc as c}from"https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("loginBtn"),e=localStorage.getItem('nombreUsuario');t&&e&&(t.textContent=`Hola, ${e}`)}),document.getElementById("registerForm").addEventListener("submit",async function(e){e.preventDefault();const n=document.getElementById("registerUsername").value,a=document.getElementById("registerEmail").value,o=document.getElementById("registerBirthdate").value,r=document.getElementById("registerPassword").value,i=document.getElementById("confirmPassword").value;if(r!==i)return void alert("Las contraseñas no coinciden.");if(!n.trim())return void alert("El nombre de usuario es obligatorio.");if(!o)return void alert("La fecha de nacimiento es obligatoria.");try{const e=await n(t,a,r),i=e.user;await updateProfile(i,{displayName:n}),await s(d(db,"users",i.uid),{username:n,email:a,birthdate:o,createdAt:new Date().toISOString(),uid:i.uid,profileComplete:!0}),alert("¡Cuenta creada correctamente! Bienvenido "+n),closeRegisterModal(),document.getElementById("registerForm").reset()}catch(e){console.error("Error al crear la cuenta:",e);let t="Error desconocido";switch(e.code){case'auth/email-already-in-use':t="Este correo electrónico ya está registrado";break;case'auth/weak-password':t="La contraseña debe tener al menos 6 caracteres";break;case'auth/invalid-email':t="Correo electrónico no válido";break;default:t=e.message}alert("Error: "+t)}}),document.getElementById("loginForm").addEventListener("submit",async function(e){e.preventDefault();const n=document.getElementById("loginEmail").value,a=document.getElementById("loginPassword").value;try{const e=await a(t,n,a),o=e.user,d=await u(o.uid),s=d?d.username:o.displayName||o.email;localStorage.setItem('nombreUsuario',s),alert("¡Bienvenido de vuelta, "+s+"!"),closeLoginModal(),document.getElementById("loginForm").reset()}catch(e){console.error("Error al iniciar sesión:",e);let t="Error desconocido";switch(e.code){case'auth/user-not-found':t="No existe una cuenta con este correo electrónico";break;case'auth/wrong-password':t="Contraseña incorrecta";break;case'auth/invalid-email':t="Correo electrónico no válido";break;case'auth/too-many-requests':t="Demasiados intentos fallidos. Intenta más tarde";break;default:t=e.message}alert("Error: "+t)}});async function u(t){try{const e=d(db,"users",t),n=await c(e);return n.exists()?n.data():null}catch(t){return console.error("Error al obtener datos del usuario:",t),null}}window.showRegisterForm=function(){document.getElementById("registerModal").style.display="block",document.getElementById("loginModal").style.display="none"},window.closeRegisterModal=function(){document.getElementById("registerModal").style.display="none"},window.closeLoginModal=function(){document.getElementById("loginModal").style.display="none"},window.showLoginModal=function(){document.getElementById("loginModal").style.display="block"};async function m(e){const n=document.getElementById("loginBtn"),a=document.getElementById("accountMenu");if(n)if(e){const o=await u(e.uid),r=o?o.username:e.email;n.textContent=`Hola, ${r}`,n.onclick=function(e){e.stopPropagation(),window.location.href='perfil.html'}}else n.textContent="Iniciar Sesión",n.onclick=function(){showLoginModal()},a&&(a.style.display="none")}document.addEventListener("DOMContentLoaded",function(){const n=document.getElementById("logoutBtn");n&&n.addEventListener("click",function(){r(t).then(()=>{document.getElementById("accountMenu").style.display="none",alert("Sesión cerrada correctamente")})}),o(t,async e=>{await m(e),e&&(console.log("Usuario activo:",e.email),await u(e.uid)),console.log("Ningún usuario ha iniciado sesión.")}),document.addEventListener("click",function(e){const t=document.getElementById("accountMenu"),n=document.getElementById("loginBtn");t&&n&&"block"===t.style.display&&!t.contains(e.target)&&e.target!==n&&(t.style.display="none")})});
